---
title: 미션! 도메인 이전하기
author: serin
date: 2023-05-17 20:55:00 +0800
categories: [Infra, AWS]
tags: [amplify, cloudFront]
pin: false
---

## 신규 도메인 이전을 계획하게 되다.

기존에 운영중이던 웹 페이지를 새로운 통합 도메인으로 이전해 달라는 요청이 왔다. 네트워크에 대한 지식이 전무하던 나는 이 임무를 완수하기 위해 삽질의 굴레에 떨어지게 된다..

### 배경

1. 앞으로 회사의 모든 도메인을 `bbb.com` 으로 사용하도록 결정되었다.
2. 우리는 구글 도메인을 통해 도메인을 관리하고 있다.
3. `bbb.com` 은 워드프레스 서버와 연결되어 있다.
4. 워드프레스는 라우팅 기능이 없다.
5. `aaa.com/page` 페이지에는 메일 발송 등 다양한 기능이 엮여있으므로 워드프레스에서 구현할 수 없다.

👉 따라서! 기존에 제공하던 `aaa.com/page` url을 `bbb.com/page` 으로 이전해야 한다.

### 시도 1. CloudFront 생성

요구사항을 보면 reverse proxy 를 구축하면 되는 일이었다.
특정 규칙으로 끝나는 url들을 proxy 에서 구분하여 이전시키는 것을 목적으로 DNS에서 바로 워드프레스로 이동하던 형태의 중간에 CloudFront 로 proxy 를 구축하였다.

![도메인1](/assets/img/Infra/20230517/도메인1.png)

[출처](https://aws.amazon.com/ko/blogs/architecture/serving-content-using-fully-managed-reverse-proxy-architecture/)

CloudFront 를 선택하게 된 방법은 위 출처 링크의 내용을 따랐다. reverse proxy 를 구축하는 방법은 총 3가지 정도가 있다. 간단하게 요약하자면,

1. AWS Amplify
   1. 풀스택 서버리스 배포 앱이다. 깃 베이스로 프론트 개발자가 손쉽게 앱을 배포할 수 있도록 도와준다.
   2. 해당 서비스의 "Rewrites and redirects" 기능을 통해 다양한 url 타겟팅을 지정할 수 있다.
   3. 가장 간단하다.
2. Amazon API Gateway
   1. API를 생성, 게시, 유지관리 할 수 있는 관리형 서비스이다.
   2. REST API 의 HTTP proxy 통합 패턴을 설정할 수 있다.
   3. 나는 페이지 리디렉션 기능이 필요한 것이므로 적합하지 않다.
3. Amazon CloudFront and AWS Lambda@Edge
   1. CND(Content Delivery Network) 서비스이다. 캐시 서버 등 다양한 경로 패턴의 수신 요청을 처리한다. 다른 오리진 그룹으로의 라우팅 기능을 지원한다.
   2. Lambda@Edge 기능을 통해 경로 패턴을 변경할 수 있다.

우선은 내가 원하는 것은 확장성 있게 라우팅 기능을 구축해놓는 것이므로 3번의 CloudFront 먼저 시도를 하였다. (현재는 리디렉션할 페이지가 1개밖에 없었지만, 회사 사업 구조상 분명 더 늘어날 것으로 예상하였다.)

내가 원하는 그림은 대략 아래와 같다. 사용자가 기본 도메인으로 들어올 때, 기본값은 기존의 워드프레스 페이지로 이동하게 되고, 특정 조건의 url 로 입력되었을 때에만 필요한 페이지로 이동하게 리디렉트 하는 것이다.

![도메인2](/assets/img/Infra/20230517/도메인2.png)

해당 방식을 구현하기 위해 진행한 설정들은 아래와 같다. (결론적으로 제대로 동작하지 않았다.)

1. `bbb.com` 원본의 CloudFront 배포
2. Behavior 에 경로 동작 생성
   1. 기본값
   2. /page\*
3. DNS에서 루트 주소의 경로를 CNAME 으로 설정하여 CloudFront 를 바라보도록 설정

제대로 동작하지 않던 부분들은 아래와 같다.

1. 동작 조건에 따른 리디렉션이 제대로 이루어지지 않았다. 자꾸 `static.bbb.com` 이 아니라 `bbb.com` 으로 이동했다.
   1. CloudFront 동작을 제대로 지정하지 못했을 수도 있지만, 확인하는 데에 너무 많은 시간이 들었고 제대로 변경 사항이 반영이 된건지도 확인하기가 힘들었다.
   2. 워드프레스에서 url 을 어떻게 받아서 처리하는지 알 수 없었다.
   3. 눈물이 났다..
2. url preserve 기능을 설정할 수 없었다.
3. (_중요!_) 구글 도메인의 루트 경로는 CNAME 으로 설정할 수 없다..! CloudFront 는 IP 가 고정되어 있지 않으므로 A 타입도 쓸 수 없었다..! 이도저도 못하는 상황..!
   1. 루트 -> `www.bbb.com` -> cloudfront 로 재설정을 하였다.
4. `wp.bbb.com` 으로 리디렉션되면, 워드프레스에서 자동으로 루트 경로로 다시 리디렉션하여 무한 루프에 빠지게 되었다...

![도메인3](/assets/img/Infra/20230517/도메인3.png)

결국 3번만 해결하고 나머지 1,2,4 번은 해결하지 못한 채로 시간만 보내게 되었다..
대체 어떤게 문제였을까, 나중에 따로 CloudFront 를 기회가 있다면 제대로 구축해 봐야 겠다는 생각을 뒤로 남겨두고, 구현 기한을 맞추기 위해 대체 서비스로 변경하게 되었다.

### 시도 2. Amplify

우선 위 문제 상황들을 해결하기 위한 대안들을 어서 생각해 보자.

1. CloudFront 가 제대로 동작하지 않는 문제 (1,2번)
   1. 이 문제의 가장 큰 원인은 CloudFront 자체 특정인 배포 속도에 있다. 배포 속도 및 적용 시간이 느리니 제대로 시간 내 문제를 해결하기 어려웠고, 서비스 자체도 나에게 복잡한 느낌이 있었다.
   2. **해결 방안 >> Amplify 를 시도해보자..!**
2. 워드프레스가 이상하게 리디렉션을 하여 무한 루프에 빠지는 문제 (4번)
   1. 루프를 끊어야 한다.
   2. **해결 방안 >> 워드프레스 URL 자체를 `wp.bbb.com` 으로 설정하자. url preserve 를 설정하면 사용자가 입력한 `bbb.com` 은 그대로 url 창에 나타나고, 페이지만 `wp.bbb.com` 으로 이동하고 끝날 것이다.**

Amplify 앱을 생성하여 배포하고, 리디렉션 기능만 새로 추가해 주었다. 아래와 같이 기본 값은 `wp.bbb.com` 으로 이동하고, 특정 url 은 `static.bbb.com` 으로 이동하도록 설정하였다. preserve 기능을 위해 200 형식으로 전달되도록 설정하였다. (301, 302 아님)

![도메인4](/assets/img/Infra/20230517/도메인4.png)

그리고, Amplify 를 DNS 와 연결하기 위해 도메인 관리 탭에서 루트 경로가 아닌 `www` 경로의 도메인을 CNAME 으로 추가하였다.

![도메인5](/assets/img/Infra/20230517/도메인5.png)

여기까지, Amplify 설정 완료..! 테스트 해 보니 원하는 대로 잘 동작하는 것을 확인할 수 있었다. (🎉)
그 다음, 워드프레스 주소를 `wp.bbb.com` 으로 변경하고, SSL 인증서를 등록하여 무한 루프를 끊어내고 나니, 내가 처음에 원했던 상황처럼 잘 동작하는 것까지 확인할 수 있었다.

적나라한 삽질 과정은 적지 않았지만, 이 업무를 진행하며 모든 과정이 처음이었던 나에게는 참 힘들었던 시간이었다. 네트워크에 대한 기본 지식, AWS 서비스 활용 방법, 워드프레스 설정 방법 등등 하나부터 끝까지 모두 구글링으로 채워졌던 나의 시간들이 나의 밑거름이 되어줄 수 있기를 바라며...

해당 도메인을 변경한 후, 추가적으로 고정 도메인에 데이터 분석 툴을 붙이는 작업이 기다리고 있고, 모든 과정은 다음주 내에 다 완료되어야 하는 상황이다. 시간에 쫓겨 구현만 완료 하였지만 시간이 더 있었다면 더 많은 시도를 해볼 수 있을 것 같다.
